function asyncFetchVertexDataById(e,t,n){$.getJSON(t+"/"+e,n)}function asyncFetchDataMatchingFilters(e,t,n){$.getJSON(t+"/?filter="+JSON.stringify(e.serialize())).done(function(t){n({filterName:e.name,results:t})}).fail(function(t){n({filterName:e.name,results:null,status:t.status,error:t.statusText})})}function getColor(e,t){return"vertex"==t?colorPool(e):"#555"}function transformColor(e,t){var n="#";e=e.substr(1,e.length);for(var i=0;i<3;i++){var l=parseInt(e.substr(2*i,2),16);l=Math.round(Math.min(Math.max(0,l+l*t),255)),n+=l.toString(16)}return n}function dictToStr(e,t){void 0===t&&(t=",");var n="";for(var i in e)n&&(n+=t+" "),n+='<span class="info-properties-key">'+i+'</span>: <span class="info-properties-value">'+e[i]+"</span>";return n}function createTagHTML(e){return'<span class="label" style="background-color:'+e.color+';"><strong>'+e.label.toUpperCase()+"</strong></span> "}function deleteChildrenFromCollection(e,t,n){function i(n){r=t[d][n].id,r!==e&&a.indexOf(r)===-1&&null!==t[d][n].parentVertexId&&a.push(r)}for(var l=0,a=[e],r=null;a.length>0;){e=a.pop();for(var d=0;d<t.length;d++)t[d].parentVertexId===e&&("edge"===t[d].type&&["source","target"].forEach(i),"vertex"===t[d].type&&(r=t[d].id,r!==e&&a.indexOf(r)===-1&&a.push(r)),delete n[t[d].id],t.splice(d--,1),l++)}return l}function processData(e,t,n){void 0===t&&(t={vertices:{},edges:{}});var i=t.vertices.raw||{},l=t.edges.raw||{},a=[],r=[],d=t.labels||{vertex:[],edge:[],tags:{vertex:{},edge:{}}},o=[],s=[];e.vertices.forEach(function(e){if(void 0===i[e.id]){var t=e.properties.name||e.id;i[e.id]={type:"vertex",id:e.id,name:t,label:e.label,color:transformColor(getColor(e.label,"vertex"),.3),borderColor:getColor(e.label,"vertex"),imports:[],in_connections:parseInt(e.metadata.in_edge_count)||0,out_connections:parseInt(e.metadata.out_edge_count)||0,visiblyConnectedEdges:[],isVisible:!0,parentVertexId:n?n.id:null,href:e.href},void 0===d.tags.vertex[e.label]&&(d.tags.vertex[e.label]=createTagHTML(i[e.id])),i[e.id].info=d.tags.vertex[i[e.id].label]+e.id+" {"+dictToStr(e.properties)+"}",i[e.id].parentVertexId===e.id&&(i[e.id].parentVertexId=null),d.vertex.indexOf(e.label)===-1&&d.vertex.push(e.label),o.push(i[e.id])}}),e.edges.forEach(function(e){if(void 0===l[e.id]){var t=i[e.head_id],a=i[e.tail_id];l[e.id]={type:"edge",id:e.id,source:t,target:a,label:e.label,color:getColor(null,"edge"),properties:e.properties,isVisible:!0,parentVertexId:n?n.id:null},void 0===d.tags.edge[e.label]&&(d.tags.edge[e.label]=createTagHTML(l[e.id])),l[e.id].info="("+t.id+") "+d.tags.edge[l[e.id].label]+" â†’  ("+a.id+") {"+dictToStr(e.properties)+"}",s.push(l[e.id]),i[e.head_id].imports.push(e.tail_id),d.edge.indexOf(e.label)==-1&&d.edge.push(e.label)}});for(var c in i)a.push(i[c]);for(c in l)r.push(l[c]);return{vertices:{raw:i,diff:o,group:a},edges:{raw:l,diff:s,group:r},labels:d}}function attachHelpMenu(e,t){function n(e,t){var n=document.createElement("li");n.innerHTML="<strong>"+e+"</strong> "+t,l.appendChild(n)}var i=document.createElement("div"),l=document.createElement("ul");t.pin!==!1&&(n("Left Click","to pin and/or move a node around"),n("Right Click","to unpin a node")),t.openNewTab!==!1&&n("Middle Click","to open in another tab"),t.expand!==!1&&(n("Double Click","to expand a node"),n("Shift + Double Click","to collapse a node")),t.reCenter!==!1&&n("Ctrl + Double Click","to re-center to the node"),n("?","to toggle this help"),i.className="help",l.className="list-unstyled",i.appendChild(l),e.append($(i)),$(window).keypress(function(e){63===e.keyCode&&$(".help").toggleClass("deactivated")})}function attachControlPanel(e){function t(e,t,n,i,l){var a=document.createElement("li"),r=document.createElement("input"),d=document.createElement("label"),o=document.createElement("span");return r.type="radio",r.name="ruruki-cp-tabs",r.id="ruruki-cp-tab-"+e,r.checked=void 0!==l&&l,o.className=n,d.className="ruruki-cp-tabs label",d.htmlFor="ruruki-cp-tab-"+e,d.title=t,d.appendChild(o),a.className="ruruki-cp-tabs-container",a.appendChild(r),a.appendChild(d),a.appendChild(i),i.className="ruruki-cp-tab-content",i.id="ruruki-cp-tab-content-"+e,a}var n=document.createElement("div"),i=document.createElement("div"),l=document.createElement("div"),a=document.createElement("ul"),r=document.createElement("div"),d=document.createElement("div"),o=document.createElement("span"),s=document.createElement("div"),c=document.createElement("span"),u=document.createElement("div"),p=document.createElement("div"),f=document.createElement("div"),h=document.createElement("ul"),m=document.createElement("div"),g=document.createElement("ul"),v=document.createElement("div"),y=document.createElement("div"),b=document.createElement("ul");a.className="ruruki-cp-tabs",a.appendChild(t("pre","Pre Defined Filters","glyphicon glyphicon-tags",u,!0)),a.appendChild(t("custom","Custom Filters","glyphicon glyphicon-search",p)),n.className="ruruki-cp",i.className="ruruki-cp-title",l.className="container inspector",r.className="container inspector",d.className="row title",o.className="inspector-title",o.appendChild(document.createTextNode("Control Panel")),c.className="glyphicon glyphicon-resize-small",s.className="inspector-expander",s.appendChild(c),d.appendChild(o),d.appendChild(s),f.className="row property",h.className="list-unstyled",h.id="inspector-toggle-vertex",f.appendChild(h),m.className="row property",g.className="list-unstyled",g.id="inspector-toggle-edge",m.appendChild(g),u.appendChild(f),u.appendChild(m),v.id="custom-defined-filter-editor",y.className="row property",y.id="BLA",b.className="list-unstyled",b.id="inspector-custom-filters",y.appendChild(b),p.appendChild(v),p.appendChild(y),l.appendChild(a),r.appendChild(d),n.appendChild(l),i.appendChild(r),e.append($(n)),e.append($(i)),c.onclick=function(){"hidden"===n.style.visibility?(c.className="glyphicon glyphicon-resize-small",n.style.visibility="visible"):(c.className="glyphicon glyphicon-resize-full",n.style.visibility="hidden")}}function attachInfoPanel(e){var t=document.createElement("div"),n=document.createElement("div");t.className="ruruki-info info",t.appendChild(document.createTextNode("Loading info...")),n.className="ruruki-info detail",n.appendChild(document.createTextNode("Loading detail...")),e.append($(t)),e.append($(n))}function loadCSS(e){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="all",document.head.appendChild(t)}var MAX_RADIUS=40;if("d3"in window)var colorPool=d3.scale.category10();var CustomFilter=function(e,t){t||(t="blue"),this.id="cf"+Date.now(),this.name=e,this.filters=[],this.linkTypes=[],this.color=t,this.result=null};CustomFilter.prototype.clone=function(){var e=JSON.parse(JSON.stringify(this)),t=new CustomFilter;for(var n in e)t[n]=e[n];return t},CustomFilter.prototype.add=function(e,t){if(!e)throw"Invalid filter: "+e+"! Ignored!";if(t=(t||"AND").toUpperCase(),"AND"!==t&&"OR"!==t)throw"Invalid filter link type: "+t+"! Defaulting to AND";this.filters.push(e),this.filters.length>1&&this.linkTypes.push(t||"AND")},CustomFilter.prototype.remove=function(e){if(!e)throw"Invalid filter: "+e+"! Ignored!";var t=this.filters.indexOf(e);if(t===-1)throw"Filter not in sequence! Ignoring...";this.filters.splice(t,1),0===this.filters.length&&(this.linkTypes=[]),this.linkTypes.length>0&&(0===t?this.linkTypes.splice(0,1):this.linkTypes.splice(t-1,1)),this.result=null},CustomFilter.prototype.forEach=function(e,t){for(var n=0;n<this.filters.length;n++)e(this.filters[n],this.linkTypes[n-1])},CustomFilter.prototype.serialize=function(){var e=[];return this.forEach(function(t,n){e.push([t,n])}),e};var RurukiEye=function(e){function t(){_=M.width()||_,P=M.height()||P,$(".ruruki-main-responsive").css("width",_),$(".ruruki-main-responsive").css("height",P),H.attr("viewBox","0 0 "+_+" "+P)}function n(){J=J.data(R),K=K.data(Y),U=U.data(R),H.append("defs").selectAll("marker").data(L.labels.edge).enter().append("marker").attr("class","arrowhead").attr("id",function(e){return e}).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5"),J.enter().append("text").attr("class",function(e){return"vertex text "+e.label}).attr("x",function(e){return h(e)+5}).attr("y",".31em").attr("id",function(e){return"vertex-text-"+e.id}).text(function(e){return e.name}),K.enter().append("path").attr("class",function(e){return"edge "+e.label}).attr("marker-end",function(e){return"url(#"+e.label+")"}).attr("id",function(e){return"edge-"+e.id}).on("mouseover",b).on("mouseout",x),U.enter().append("circle").attr("class",function(e){var t="vertex node "+e.label;return e.id==D&&(e.fixed=!0,e.clean=!0,t+=" fixed"),t}).attr("stroke",function(e){return e.id==D?V:e.borderColor}).style("fill",function(e){return e.id==D?V:e.color}).attr("r",function(e){return h(e)}).attr("id",function(e){return"vertex-"+e.id}).on("dblclick",w).on("click",y).on("mouseover",C).on("mouseout",x).on("contextmenu",v).call(z),p()}function i(e){var t=$(e.target).data();t.filterName&&S[t.filterName].result&&["vertices","edges"].forEach(function(e){var n="vertices"===e?"vertex":"edge";S[t.filterName].result[e].forEach(function(t){node=L[e].raw[t.id],node&&(H.selectAll("#"+n+"-"+node.id).classed("highlighted",!0),"vertex"===n&&H.selectAll("#"+n+"-text-"+node.id).classed("highlighted",!0))})})}function l(e){var t=$(e.target).data(),n="."+t.entityType+"."+t.entityLabel;H.selectAll(n).classed("highlighted",!0)}function a(){H.selectAll(".edge").classed("highlighted",!1),H.selectAll(".vertex").classed("highlighted",!1)}function r(e){return function(){s(S[e])}}function o(e){var t=S[e.filterName];if(t){var n=document.getElementById("custom-filter-"+t.id),i=document.getElementById("custom-filter-icon-"+t.id);void 0!==e.error&&(i.title="Invalid Filter! - "+e.error,i.style.display="inline",i.style.color="red"),t.result=e.results,t.result?$(n).removeClass("disabled"):$(n).addClass("disabled")}}function s(e,t){function n(e){f.disabled=!1,h.disabled=!1,m.disabled=!1}function i(t,i){if(i){var l=document.createElement("h1");l.className="ruruki-cp-divider",l.id="ruruki-cf-link-"+E,l.value=i,l.title="Click to change link type or right click to delete",l.appendChild(document.createTextNode(i)),l.onclick=function(e){var t=l.value;t="OR"===t?"AND":"OR",l.value=t,l.removeChild(l.childNodes[0]),l.appendChild(document.createTextNode(t)),f.disabled=!1,h.disabled=!1},l.oncontextmenu=function(n){n.preventDefault();try{e.remove(t)}catch(i){}s(e,!1)},a.appendChild(l)}var r=document.createElement("input");r.id="ruruki-cf-value-"+E++,r.type="text",r.placeholder="Filter",r.onkeyup=n,t&&(r.value=t),a.appendChild(r)}e=null===e?null:e.clone(),t=void 0===t||t;var l=document.getElementById("custom-defined-filter-editor");$(l).empty();var a=document.createElement("div"),r=document.createElement("div"),d=document.createElement("div"),u=document.createElement("div"),p=document.createElement("button"),f=document.createElement("button"),h=document.createElement("button"),m=document.createElement("button"),g=document.createElement("span"),v=document.createElement("span"),y=document.createElement("span"),b=document.createElement("span"),C=document.createElement("input"),x=document.createElement("input"),E=0;return f.disabled=t,a.className="row property",r.className="row property",C.placeholder="Name",C.type="text",C.id="ruruki-cf-name",C.onkeyup=n,x.placeholder="Color",x.type="text",x.id="ruruki-cf-color",x.onkeyup=n,x.value="#00c",a.appendChild(C),a.appendChild(x),p.type="button",p.className="btn btn-xs btn-default",g.className="glyphicon glyphicon-plus",p.appendChild(g),p.title="Add Filter",p.onclick=function(){i("","AND")},f.type="button",f.className="btn btn-xs btn-success",v.className="glyphicon glyphicon-ok",f.appendChild(v),f.title="Save",f.onclick=function(){var t,n,i=new CustomFilter;i.name=document.getElementById("ruruki-cf-name").value,i.color=document.getElementById("ruruki-cf-color").value,i.add(document.getElementById("ruruki-cf-value-0").value);for(var l=1;l<E;l++)t=document.getElementById("ruruki-cf-value-"+l).value,n=document.getElementById("ruruki-cf-link-"+l).value,i.add(t,n);e&&delete S[e.name],S[i.name]=i,o({filterName:i.name,id:i.id,results:null},S),asyncFetchDataMatchingFilters(i,F,function(e){o(e,S)}),c(),s(null)},h.type="button",h.className="btn btn-xs btn-warning",y.className="glyphicon glyphicon-remove",h.appendChild(y),h.title="Cancel editing",h.onclick=function(){s(null)},m.type="button",m.className="btn btn-xs btn-danger",b.className="glyphicon glyphicon-trash",m.appendChild(b),m.title="Delete",m.onclick=function(){delete S[e.name],c(),s(null)},u.className="ruruki-cp-cf-controls left",u.appendChild(p),r.appendChild(u),d.className="ruruki-cp-cf-controls right",d.appendChild(f),r.appendChild(d),l.appendChild(a),l.appendChild(r),e&&e.filters&&0!==e.filters.length?(C.value=e.name,x.value=e.color,e.forEach(i),d.appendChild(h),d.appendChild(m)):i(),l}function c(){var e=$(document.getElementById("inspector-custom-filters"));e.empty();for(var t in S){var n=S[t],l=n.name,d=document.createElement("li"),o=$(d),s=document.createElement("label"),c=document.createElement("span"),u=document.createElement("strong"),p=document.createElement("span");n.forEach(function(e,t){t&&(l+=" "+t),l+=" "+e}),p.className="glyphicon glyphicon-warning-sign",p.style.display="none",p.id="custom-filter-icon-"+n.id,u.appendChild(document.createTextNode(t+"  ")),u.appendChild(p),u.dataset.filterName=t,c.className="label",c.style.backgroundColor=n.color,c.dataset.filterName=t,c.appendChild(u),s.className="inspector property",s.dataset.filterName=t,s.id="custom-filter-"+n.id,s.appendChild(c),n.result||(s.className+=" disabled"),d.dataset.filterName=t,d.title=l,d.appendChild(s),o.hover(i,a),o.click(r(n.name)),e.append(o),console.log("key",t,"filter",n)}}function u(){["edge","vertex"].forEach(function(e){var t=$("#inspector-toggle-"+e).empty();L.labels[e].forEach(function(n){var i=$("<li>"),r=$('<label class="inspector property">'+L.labels.tags[e][n]+"</label>");r.data({entityType:e,entityLabel:n}),r.children().data({entityType:e,entityLabel:n}),r.hover(l,a),i.append(r),t.append(i),O.status[e][n]===!1&&r.addClass("disabled"),r.on("click",function(){r.toggleClass("disabled"),O.status[e][n]=!r.hasClass("disabled"),E(e,n,O)})})})}function p(){q.html("Showing <i>"+Y.length+"</i> edges linked to <i>"+R.length+"</i> vertices")}function f(){B?(U.attr("cx",function(e){return e.id===D&&e.clean===!0?e.x=e.px=_/2:e.x=Math.max(h(e),Math.min(_-h(e),e.x))}),U.attr("cy",function(e){return e.id===D&&e.clean===!0?e.y=e.py=P/2:e.y=Math.max(h(e),Math.min(P-h(e),e.y))})):U.attr("transform",m),J.attr("transform",m),K.attr("d",function(e){return diffX=e.target.x-e.source.x,diffY=e.target.y-e.source.y,pathLength=Math.sqrt(Math.pow(diffX,2)+Math.pow(diffY,2)),offsetX=diffX*h(e.target)/pathLength,offsetY=diffY*h(e.target)/pathLength,"M"+e.source.x+","+e.source.y+"L"+(e.target.x-offsetX)+","+(e.target.y-offsetY)})}function h(e){return Math.min(5+.4*Math.max(e.in_connections,e.out_connections),MAX_RADIUS)}function m(e){return e.id==D&&e.clean===!0&&(e.x=_/2,e.y=P/2),"translate("+e.x+","+e.y+")"}function g(t){e.pin!==!1&&(t.id===D&&t.clean===!0&&delete t.clean,t&&d3.select(this).classed("fixed",t.fixed=!0))}function v(t){console.log(t,e),d3.event.preventDefault(),e.pin!==!1&&(t.id===D&&t.clean===!0&&delete t.clean,t&&d3.select(this).classed("fixed",t.fixed=!1))}function y(t){if(d3.event.preventDefault(),e.openNewTab!==!1&&t&&1===d3.event.button){var n=t.href||"/vertices/"+t.id;d3.event.ctrlKey?win=window.open(n,"_blank"):window.location=n}}function b(e){e.isVisible===!0&&(H.selectAll(".edge").classed("highlighted",function(t){return t===e}),H.selectAll(".vertex").classed("highlighted",function(t){return t===e.source||t===e.target}),W.html(e.info))}function C(e){e.isVisible===!0&&(H.selectAll(".edge").classed("highlighted",function(t){return t.source===e||t.target===e}),d3.select(this).classed("highlighted",!0),d3.select("#vertex-text-"+e.id).classed("highlighted",!0),W.html(e.info))}function x(){H.selectAll(".highlighted").classed("highlighted",!1),W.text("")}function E(){R.forEach(function(e){void 0===O.status[e.type][e.label]&&(O.status[e.type][e.label]=!0),e.isVisible=O.status[e.type][e.label],e.id==D&&(e.isVisible=!0)}),Y.forEach(function(e){void 0===O.status[e.type][e.label]&&(O.status[e.type][e.label]=!0),e.isVisible=O.status[e.type][e.label],e.source.isVisible!==!1&&e.target.isVisible!==!1||(e.isVisible=!1),e.isVisible===!1?(e.source.visiblyConnectedEdges.indexOf(e.id)!==-1&&e.source.visiblyConnectedEdges.splice(e.source.visiblyConnectedEdges.indexOf(e.id),1),e.target.visiblyConnectedEdges.indexOf(e.id)!==-1&&e.target.visiblyConnectedEdges.splice(e.target.visiblyConnectedEdges.indexOf(e.id),1)):(e.source.visiblyConnectedEdges.indexOf(e.id)===-1&&e.source.visiblyConnectedEdges.push(e.id),e.target.visiblyConnectedEdges.indexOf(e.id)===-1&&e.target.visiblyConnectedEdges.push(e.id)),0!==e.source.visiblyConnectedEdges.length&&0!==e.target.visiblyConnectedEdges.length||(e.isVisible=!1),e.source.id==D&&(e.source.isVisible=!0),e.target.id==D&&(e.target.isVisible=!0)}),d3.selectAll(".vertex").attr("opacity",function(e){return e.id===D?1:0===e.visiblyConnectedEdges.length||e.isVisible===!1?0:1}),d3.selectAll(".edge").attr("opacity",function(e){return e.isVisible===!0?1:0})}function k(t){if(e.expand!==!1)return q.html("Loading data for node <i> "+t.id+"</i>..."),void 0!==T?void T(t):void asyncFetchVertexDataById(t.id,I,function(e){L=processData(e,L,t),console.log(L.vertices.diff.length,"vertices added",L.edges.diff.length,"edges added"),L.vertices.diff.forEach(function(e){R.push(e)}),L.edges.diff.forEach(function(e){Y.push(e)}),n(),E(),u(),X.start()})}function N(t){if(e.expand!==!1){var n=0,i=0;t.id===D?Y.forEach(function(e){e.source.parentVertexId===t.id&&(n+=deleteChildrenFromCollection(e.source.id,R,L.vertices.raw),i+=deleteChildrenFromCollection(e.source.id,Y,L.edges.raw)),e.target.parentVertexId===t.id&&(n+=deleteChildrenFromCollection(e.target.id,R,L.vertices.raw),i+=deleteChildrenFromCollection(e.target.id,Y,L.edges.raw))}):(n+=deleteChildrenFromCollection(t.id,R,L.vertices.raw),i+=deleteChildrenFromCollection(t.id,Y,L.edges.raw)),console.log(n,"vertices deleted",i,"edges deleted"),J=J.data(R),K=K.data(Y),U=U.data(R),J.exit().remove(),K.exit().remove(),U.exit().remove(),p(),X.start(),u()}}function w(t){if(d3.event.preventDefault(),d3.event.shiftKey)N(t);else if(d3.event.ctrlKey){if(e.reCenter===!1)return;window.location.href="/vertices/"+t.id}else k(t)}if(void 0===e.data||void 0===e.centerId)throw'Mandatory fields missing in configuration: "data", "centerId"';var I=e.expandEndpoint||"/vertices",F=e.filterEndpoint||"",T=e.expandCallback,D=e.centerId,A=e.container||"#ruruki-eye",M=$(A),V=e.centerNodeColor||"#FFDF00",O={status:{vertex:{},edge:{}}};loadCSS(e.cssUrl||"/static/css/ruruki-eye.css");var L=processData(e.data,void 0,{id:D}),S={},B=!0,_=M.width(),P=M.height(),X=d3.layout.force().nodes(d3.values(L.vertices.raw)).links(d3.values(L.edges.raw)).size([_,P]).linkDistance(function(e){return 60+4*Math.max(h(e.target),h(e.source))}).charge(-300).gravity(0).on("tick",f).start(),z=X.drag().on("dragstart",g),H=d3.select(A).append("div").classed("ruruki-main",!0).append("svg").attr("viewBox","0 0 "+_+" "+P).classed("ruruki-main-responsive",!0);e.help!==!1&&attachHelpMenu(M,e),e.controlPanel!==!1&&attachControlPanel(M),e.controlPanel!==!1&&s(null),e.infoPanel!==!1&&attachInfoPanel(M),c();var R=X.nodes(),Y=X.links(),J=H.append("g").selectAll("text"),K=H.append("g").selectAll("path"),U=H.append("g").selectAll("circle"),q=$(".ruruki-info.info"),W=$(".ruruki-info.detail").text("");if(t(),n(),u(),window.onresize=t,$(window).load(t()),d3.event.shiftKey)N(d);else if(d3.event.ctrlKey){if(e.reCenter===!1)return;window.location.href="/vertices/"+d.id}else k(d)};